<html><body>
<h3>[15] 3D VIEWER (Cave3D)</h3>

TopoDroid 3D viewer is designed for use in cave and it does not require internet connection.<br>
It can load also other file formats: Therion (th, thconfig), Loch (lox), Compass (dat, mak), Survex (3d), and VisualTopo (tro, trox).<br><p>

The 3D model can be opened either from a menu in the <i>Data Window</i>, or a button in the
<i>Survey Info Window</i>.<br>
The 3D model of a cave project can be opened from a button in the <i>Project Window</i>.
<br><p>

The model is shown with a reference cartesian grid (blue north, green east) or triplet (pink upward).
The North is geographic if the magnetic declination is set.<br>

If the data (survey or cave project) has fixed points these are used to compute the coordinates of the points
in the model.
If the fixed points have cartographic (projected) coordinates the cartesian grid is in the projected coordinate system.
The coordinates in cartographic reference systems take into account the meridian convergence.<br>
If the fixed points have only geographic (WGS84) coordinates,
the coordinates are referred to the equator and the prime meridian and computed using the differences from the first fixed point:
the latitude times the meridian radius, and the longitude times the parallel radius, respectively.<br>
<br><p>

There is no coordinate conversion. Therefore all the surveys in a cave project must be
geo-referenced in the same coordinate system.
<br><p>



<h4>BUTTONS</h4>
<ul style="margin-top:0">
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_turn.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_move.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_light.png"> <i>Mode</i>: either rotate the model or move the model or the light (if there is a DEM).  Two-finger always scale and translate the model.</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_orthogonal.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_perspective.png"> <i>View</i>: either orthographic or perspective.</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_station_no_dot.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_station_point_dot.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_station_name_dot.png"> <i>Stations</i>: hide or show stations, as green points or names.</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_splays_none.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_splays_line.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_splays_point.png"> <i>Splays</i>: hide or show splays, as segments or endpoints.</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_wall_no.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_wall.png"> <i>Walls</i>: hide or show walls (if created).</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_surface_off.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_surface_on.png"> <i>Surface</i>: hide or show surface DEM (if present).</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_color.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_color_survey.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_color_depth.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_color_surface.png"> <i>Color</i>: midline color-coding: white, by-survey, denivelation, or surface.</li>
<li><img style="border:1px solid black" width="36" height="36" src="btn_3d_frame_grid.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_frame_axes.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_frame_no.png"> <i>Frame</i>: XY grid with vertical line, or XYZ axes, or none.</li>
</ul><br>
The button icons are adjusted to the state of the program.
<br><p>

A few buttons have long-tap actions:
<ul>
<li><i>View</i>: Adjust the focal parameter of the perspective.</li>
<li><i>Stations</i>: Toggle station selection on/off.</li>
<li><i>Color</i>: Change the survey colors and select the surveys to show or hide. Up to Android-9 the station names are shown even when the survey is hidden.</li>
<li><i>Frame</i>: Open the <i>leg dialog</i> (display of surface/duplicate/commented legs).</li>
</ul>
<br><p>

<h4>MENU</h4>
<ul style="margin-top:0">
<li><i>Open file</i>: Select a survey file from the working folder.</li>
<li><i>Export</i>: Export dialog.</li>
<li><i>Info</i>: Survey 3D info.</li>
<li><i>3D-Rose diagram</i>: Distribution of 3D directions.</li>
<li><i>Rose diagram</i>: Distribution of azimuth directions.</li>
<li><i>Reset</i>: Reset to orthogonal top view, at zoom one.</li>
<li><i>Viewpoint</i>: Select a point of view among top, north, east, south, and west. For example "south" means looking at the cave from the South.</li>
<li><i>Surface</i>: Transparency and DEM file. Centreline projection on surface.</li>
<li><i>Wall models</i>: Create or clear a wall 3D reconstruction. Toggle plan/profile projections of walls</li>
<li><i>Search</i> stations that starts with a given prefix and highlights them when station dots are shown.</li>
<li><i>Options</i></li>
<li><i>Help</i></li>
</ul><br><p>

<h4>OPTIONS</h4>
<ul style="margin-top:0">
<!-- li><i>Work Directory</i>: Folder containing the survey files</li -->
<li>
  <u>3D Viewer</u>:
  <ul>
  <li><i>Below horizon view</i>: whether to allow viewpoints below the horizon [n].</li>
  <li><i>Station points</i>: whether to always display station points (green) [n].</li>
  <li><i>Station point size</i>: radius of station points [8 pxl].</li>
  <li><i>Station text size</i>: size of station names [20 pt].</li>
  <li><i>Selection radius</i>: Radius of selection for stations [1.0]</li>
  <li><i>Distance message</i>: show distance message instead of dialog [n]</li>
  <li><i>Station dialog</i>: whether to open the station dialog for the selected station instead of box [n].</li>
  <li><i>Top grid</i>: Show the cartesian grid on the top [n].</li>
  <li><i>Grid extent</i>: amount of cartesian grid extent around the survey [10 cells]. This takes effect the next time the 3D viewer is opened.</li>
  <li><u>DEM</u>:
    <ul>
    <li><i>DEM buffer</i>: Extent of surface model around the survey on loading the surface model from a DEM file.</li>
    <li><i>DEM max size</i>: maximum size of surface DEM in each direction [400 cells].</li>
    <li><i>DEM reduction</i>: how to reduce the DEM if too large (subsample or clip) [subsample].</li>
    <li><i>texture root</i>: filesystem pathname of the storage folder ["/sdcard/"].</li>
    </ul>
  </li>
  <li><u>Wall Model</u> (some settings apply to specific wall models):
    <ul>
    <li><i>Splay usage</i>: Which splay to use (none, normal, x-sections) [normal]</li>
    <li><i>All splay</i>: Whether to use all the splays for the walls</li>
    <li><i>Projected splays</i>: Whether to use splays projected on a normal plane [n]</li>
    <li><i>Splay threshold</i>: splays outside the shot to keep [0.5]</li>
    <li><i>Split triangles</i>: Whether to split intersecting wall triangles</li>
    <li><i>Randomize points</i>: Add a small random vector to splays</li>
    <li><i>Stretch walls</i>: Shift wall points by a small quantity along the leg</li>
    <li><i>Powercrust</i>: Algorithm "delta" parameter</li>
    </ul>
  </li>
  </ul>
</li>
</ul><br><p>

<b>TITLE LINE</b><br>
The title bar shows the viewing parameters:
<ul>
<li><i>C</i> and <i>A</i> clino and azimuth of the viewpoint.</li>
<li><i>S</i> is the zoom factor.</li>
<li><i>T</i> are the X-Y translations of the model.</li>
<li><i>L</i> are the clino and azimuth of the light.</li>
</ul>
<br><p>

<b>EXPORTS</b><br>
Model can be exported as DXF, KML, GPX, STL or STL-binary, CGAL, LAS-binary, and shapefile.<br>
The exported file is selected with the Android file manager.
<br><p>

The export dialog has options to include splays, walls, stations and surface.
(Walls and surface are not supported in all export formats).<br>
The model can be also serialized in a text file.<br><p>

The GPX export of projects can have all the project surveys in a single track, or include a track
for each survey. The behavior is determined by the GXP export setting "single-track".<br><p>

<!--
The model is exported in a projected metric reference system, centered at the first fixed point.
The Y axis is the geographic or the magnetic North depending whether the magnetic declination
is specified or not. If the model is georeferenced the center has an offset computed from the central meridian and
the equator.<br><p>
-->

If the model is georeferenced the KML, GPX and shapefile exports are in WGS84 geographic coordinates.<br><p>

<b>GRID/FRAME</b><br>
It is possible to display a grid/frame of the cartesian axes:<br>
<ul>
<li>no grid/frame</li>
<li>horizontal (East-North) grid with the vertical axis</li>
<li>horizontal (East-North) grid with the vertical axis and level lines<li>
<li>East and North axes with the vertical axis and level lines<li>
</ul><br>

The grid/frame lines are green (west-east), blue (south-north), and red (vertical).<br>
In perspective the grid lines look greenish to the north/south because the green lines stack together closer.
And it looks blueish to the west/east.
To help distinguish the for cardinal directions, the grid lines get slightly reddish at the west-south corner.<br>
By default the cartesian grid is below the survey, but it can be set above it (optionally).
The line spacing (grid cell size) can be checekd in the info dialog.
<br><p>

<b>SURVEY</b><br>
The survey splays can be hidden, displayed as lines or endpoints.<br>
The survey legs can be uncolored or colored by survey, by denivelation (red-to-blue) or by
the depth beneath the surface (blue-to-red) if the model has a DEM surface.<br>

When uncolored the survey legs are white, the surface legs green, the duplicate legs orange, 
and the commented legs light blue.<br>

The "surface", "duplicate", and "commented" legs can be turned on/off with the <i>leg dialog</i> which
is opened by a long-tap on the <i>Frame</i> button (last).
<br><p>

<b>WALLS</b><br>
The wall model is not computed automatically when the file is opened, but it must be
requested by the user through the "wall" menu.
There are two general models, <i>simple hull</i>, and <i>pseudo convex-hull</i>, 
and the "debug-only" <i>powercrust</i> model.
The first two are suitable when the splay are not dense. The last one is for dense splays.<br>

The wall model depends on the number and the quality of the splays.
Poor splays will result in a poor model.<br>

The computation is done in background.
When done the wall can be displayed with the "wall" button.<br><p>

The [debug-only] powercrust model includes also the projection of the walls on the horizontal plane (plan view), and on a vertical curtain
along the survey (profile view). Their display is enabled through the "walls" menu.
<br><p>

<b>SURFACE</b><br>
For Topodroid models, a surface (Digital Elevation Model) can be added from a DEM file.
If externally loaded Therion or Loch models contain surface data (Digital Elevation Model and optionally a texture), the surface can be displayed either gray or with the texture.<br>
The surface dialog has a button to load a DEM from a file. The supported formats are ascii (.asc or .ascii) and Therion grid (.grid).<br>
Only the relevant portion of the DEM file is loaded. The DEM extent must cover the area of the model.<br>

<p>
The Esri ASCII Format must use a header like in the following example:<br>
<pre>
  ncols 374
  nrows 225
  xllcorner 7.444608
  yllcorner 46.947922
  cellsize 0.000213
  NODATA_value -99.00
  567.1 567.2 ...
  ...
</pre>
If the number of rows or columns is negative, the data is in reverse order. This option is not included in the original Esri format!<br><p>
  
A Therion grid file must use a header like in the following example and may contain comments on lines starting with "#":<br>
<pre>
  grid 7.444608 46.947922 0.000213 0.000213 374 225
  567.1 567.2 ...
  ...
</pre>

<p>Coordinate Reference Systems (CRS):</p>
<p>
The fixed stations of the survey and the DEM data file must all be in the same (cartographic) Coordinate Reference System.<br>
By default, WGS84 is used, so the coordinates and cell size must be entered in degrees (with six or more decimals for good accuracy).<br>
</p>
<p>
To use a different CRS, all fixed stations must be transformed into that other CRS using the "Convert" button in the respective "Geo-Points" dialog.
Notice: the separately available app "Proj4" must be installed as well (do not use the version from Play Store but the more current one from the Topodroid Website).
Check the INFO dialog of the 3D Viewer to verify that the required CRS is effectively in use.<br>
The DEM data must now be in that reference system instead of WGS-84 (depending on the CRS used, cellsize may now be in meters).
</p>

<p>
The transparency of the surface is adjustable. If fully opaque the portions of surface behind others are hidden.<br>
The projection of the survey centerline on the surface can be displayed (blue).<br>
When the model has a surface, it can be colored by the depth beneath the surface.
</p>

<p>
If the model has a surface DEM, the surface texture can be loaded from a file.
The supported file formats are GeoTiff and OSM.<br>
The GeoTiff file must be in the same Cartographic Coordinate Reference System of the survey.
[Tech note: if the file is 24-bit non-compressed or uses a colormap Cave3D tries to read only the portion
covering the DEM area, otherwise the whole image
is read in and portion area is extracted.]<br>
The OSM texture (WGS84) can be loaded only for surveys and cave projects opened from TopoDroid.
The texture displays the OSM lines.
<br><p>

<b>Note</b>. Texture GeoTiff file are read by native code, thus the storage pathname (ususlly ending with ':') needs to be
replaced by the filesystem pathname (usually "/sdcard/"): if this is not properly specified the GeoTiff texture 
fails to load. The GeoTiff filename with "storage" prefix is shown is a toast message.<br><p>

It is possible to visualize a point (yellow dot) on the surface by entering the East/North coordinates in the CRS of the model.<br>

Models loaded from TopoDroid can get also GNSS points.
If the app has permission to use the "Location" service, and this service is enabled, it is possible to
get surface point with the Android GNSS.<br>
given permissions to use it.<br>
The app displays the last 10 points.
<br><p> 

<b>STATION ACTIONS</b><br>
By default, when the stations are displayed, they can be selected tapping on the station point or name.<br>
Station selection can be turned on/off with a long tap on the "station" button. When the stations are selectable
the button has a red dot.<br><p>

The selected station is highlighted red, and its coordinates are shown in a blue <i>station bar</i> at the bottom.
If the model has a DEM, the depth of the station below the surface is included.<br>
To unselect the station tap the "close" button in the <i>station bar</i>.<br><p>

<img style="border:1px solid black" width="36" height="36" src="btn_3d_measure_ruler_off.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_measure_ruler_on.png"> 
To measure distances between the selected station and another station, check the "measure" button in the <i>station bar</i>,
and tap on the other station.
The 3D distance between the two stations, its East, North, and vertical components, and the plane 2D distance are
displayed in a dialog.
If the two stations are connected along the centerline the sums of the positive and of the negative "cave" denivelations between the two stations,
and the "cave" distance is also shown
and the cave-path between them is highlighted green.<br>
Optionally, the values can be displayed in a brief message box instead of a dialog.  <br><p>

<img style="border:1px solid black" width="36" height="36" src="btn_3d_measure_station_off.png"><img style="border:1px solid black" width="36" height="36" src="btn_3d_measure_station_on.png"> When the "station" button in the <i>station bar</i> is checked, the station position on the screen 
if fixed under rotations and the
selected station is highlighted orange.
<br><p>

<!--
<b>SKETCH LIFTING</b> (Experimental)<br>
With surveys and cave-projects opened from TopoDroid it is possible to "lift" 2D sketches to the 3D model.
The sketch must be exported (in TopoDroid) in "Cave3D" format. The exported file is in the "c3d" folder
of TopoDroid. Next a sketch file can be loaded from the 3D viewer, and the sketch is lifted to adapt to the
3D model.<br>

The sketch dialog displays the list of opened sketches.<br>
Each item has two checkboxes: the first to switch on/off
the display of the sketch, the second to remove the sketch. The choices must be confirmed with the "OK" button.<br>
There is a button to load a new sketch.<br>
Finally there is a button to rebind the point icons, if they go black.
<br><p>
-->


<a href="manual14.htm">&lt; Cave Projects</a> |
<a href="manual16.htm">Index &gt;</a> 

</body></html>
